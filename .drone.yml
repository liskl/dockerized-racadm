pipeline:
  auth:
    image: scottlackey/drone-auth-ecr
    auth_config:
      username: ${DOCKER_REGISTRY_USERNAME}
      password: ${DOCKER_REGISTRY_PASSWORD}
    commands:
      - aws ecr get-login --region us-east-1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  docker:
    image: plugins/docker
    repo: registry.liskl.com/llisk/dockerized-racadm
    tag:
      - ${DRONE_BRANCH/master/latest}
      - ${DRONE_BRANCH}.build-${DRONE_BUILD_NUMBER}
    force_tag: true
    storage_driver: overlay
  ecr:
    image: plugins/ecr
    access_key: ${AWS_ACCESS_KEY_ID}
    secret_key: ${AWS_SECRET_ACCESS_KEY}
    repo: ${AWS_ECR_REPO}/util/dockerized-racadm
    tags:
      - ${DRONE_BRANCH/master/latest}
      - ${DRONE_BRANCH}.build-${DRONE_BUILD_NUMBER}
